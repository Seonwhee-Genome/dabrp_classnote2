---
title: "데이터 시각화와 전처리"
author: "박찬엽"
date: "2017년 7월 26일"
output:
  xaringan::moon_reader:
    css: ["default", "class6.css"]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: '16:9'
      navigation: click
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(cache = T, fig.height = 5)
```

목차

1. 과제 확인
    - kmeans
    - 회귀분석
    - 연관분석
    
1. ggplot2
    - + 연산자
    - 그림을 그리는 구조
    - 요소별 
        - geom
        - 
        
1. ggplot2+extra
---

## 과제 확인

[과제 확인](https://github.com/mrchypark/dabrp_classnote2/blob/master/assign5.R)

---
class: center, middle

![](https://github.com/tidyverse/ggplot2/blob/master/man/figures/logo.png?raw=true)


---

## ggplot2란

[The Grammar of Graphics](http://www.springer.com/us/book/9780387245447)를 따르는 방식으로 차트를 출력물 수준으로 만들 수 있게 보조해주는 패키지. 그래서 `GG`plot 이라고 이름을 지은 것이고, 상세한 동작방식은 [여기](http://vita.had.co.nz/papers/layered-grammar.pdf)를 참고하세요. 데이터를 기하 객체(geometric object)의 미적 속성(aesthetic attributes)에 연결하는 방법을 사용합니다. 

.pull-left[
```{r, eval=FALSE, message=FALSE, warning=FALSE, include=T}
library(ggplot2)
ggplot(data=mpg) + 
  geom_point(aes(displ, hwy, colour = class))
```
]
--
.pull-right[
```{r ,echo=F, fig.height=5}
library(ggplot2)

ggplot(mpg, aes(displ, hwy, colour = class)) + 
  geom_point()
```
]
---
## 공부 자료

- [패키지 공식문서](http://ggplot2.tidyverse.org/reference/index.html)
- [cheat sheet](https://www.rstudio.com/wp-content/uploads/2016/11/ggplot2-cheatsheet-2.1.pdf)
- [R for data science](http://r4ds.had.co.nz/data-visualisation.html#introduction-1)
- [한글 자료 1](https://statkclee.github.io/R-ecology-lesson/kr/05-visualization-ggplot2.html)
- [한글 자료 2](http://freesearch.pe.kr/archives/3134)

---
## 용어 설명

- 기하 객체(geometric object) : 차트를 구성할 수 있는 그림의 형태들. bar, dot, line 등이 있음. geom_*() 형태의 함수로 layer를 구성함.
- 미적 속성(aesthetic attributes) : 각 기하 객체들의 모양을 결정하기 위한 요소들. 공통적으로 x, y, color 등이 있음.
- 연결(mapping) : 데이터의 컬럼을 필요한 미적 속성에 해당함을 명시적으로 작성하는 것.
- ggplot 자료형 : ggplot()함수로 생성하는 R 객체로 그림을 그리기 위한 정보를 포함하고 있음.
- 계층(layer) : 제공된 데이터와 연결 정보를 바탕으로 그려진 그림. + 연산자를 통해 계층을 추가하여 겹쳐서 그리는 것이 가능.
- `+` 연산자 : 계층을 추가할 때 데이터와 연결 정보, 지금까지 작성된 계층 정보를 전달하는 연산자. 파이프 연산자(`%>%`)와 비슷함.
- 좌표계(coordinate system) : 대표적인 x-y 좌표계를 사용하며 극좌표계(polar) 등으로 파이차트를 작성할 수 있음.
- 축척(scale) : 데이터를 표시하는 방식으로 연속형 자료형에서 고려함.

---

## ggplot 객체

`ggplot`은 그림 그리는 정보를 가지는 layer들을 겹쳐서 차트를 그리는 방식을 이용합니다. 대부분은 자동으로 지정을 해주고, 필수로 작성해야 하는 layer의 요소는 데이터, 연결정보, 기하 객체 입니다.

```
layer = ggplot(data, aes(<mapping>)) + geom_*
```
--
여러 layer를 겹칠 때 데이터와 연결정보 중에 공통으로 사용하는 것은 ggplot()함수로 작성하여 geom_요소만 `+` 연산자로 연결하여 layer를 겹치는 방식을 사용합니다.

```
ggplot(data, aes(<mapping>) ) +  # 공통 정보
  geom_요소1 +                   # 레이어 1의 구성
  geom_요소2                     # 레이어 2의 구성

```

---

## gapminder 데이터 소개

gapminder는 [움직이는 버블 차트](http://www.gapminder.org/tools/#_locale_id=en;&chart-type=bubbles)로 유명한 데이터셋입니다. [코드북](https://github.com/jennybc/gapminder)과 `str`을 확인하면서 데이터를 확인하겠습니다.

```{r}
if (!require("gapminder")){install.packages("gapminder")}
library(gapminder)
str(gapminder)
```


---

## ggplot 객체 만들기

.pull-left[
```{r fig.height=5}
p <-ggplot(gapminder, 
           aes(x = gdpPercap, y = lifeExp))
p
```
]
.pull-right[
```{r}
summary(p)
```
]

---

## geom 추가 하기 point

.pull-left[
```{r fig.height=5}
p_point <- p + geom_point()
p_point
```
]

--
.pull-right[

`summary(p_point)`를 이용해 `summary(p)`와 어떻게 달라졌는지 확인해 보세요.

]

---

## 실습 1
.pull-left[
1. `gapminder`에서 `country`가 `Afghanistan`인 데이터만 뽑아서 `gap_af`로 저장하세요.
1. `gap_af`를 x축은 year, y축은 lifeExp로 line 차트를 그리세요.
]

.pull-right[

```{r echo=F, fig.height=5}
 ggplot(gapminder[gapminder$country=="Afghanistan",], aes(x=year, y=lifeExp)) + geom_line()
```
]

---

## ggplot 내장 함수 사용시 장점

 ggplot은 매우 많은 함수를 제공하고 있으며 대부분 자동으로 지원하지만 명시적으로 필요한 부분을 수정할 수 있습니다. `+` 연산자로 수정하고자 하는 부분을 추가하는 방식이며 추가된 함수가 자동으로 작성된 것보다 우선 하는 방식으로 적용됩니다.
 
 이 때 몇 가지 장점이 있는데,
 
    1. 데이터 + 연결 정보를 가진 ggplot 객체를 수정 없이 재사용할 수 있음
    1. 코드를 재사용함으로써 작성량을 줄일 수 있음
    1. 파이프 연산자와 같이 가독성이 높아짐

---

## scale 변경하기 
.pull-left[
```{r}
p_point
```
]


.pull-right[
```{r}
ggplot(gapminder, aes(x = log10(gdpPercap), y = lifeExp)) +
  geom_point()
```
]

---

## scale_* 함수로 변경하기

.pull-left[
```{r }
p_point
```
]


.pull-right[
```{r}
(p_point_log10 <- p_point + scale_x_log10())
```
]


---

## aes의 공통 정보

ggplot [cheatsheet](https://www.rstudio.com/wp-content/uploads/2016/11/ggplot2-cheatsheet-2.1.pdf)에 보면 각 geom에 따른 aes를 설명하고 있습니다. 그 중 많이 보이는 몇 가지를 소개합니다.

- x: x-y 좌표계에서 x축으로 표시할 데이터를 뜻합니다.
- y: x-y 좌표계에서 y축으로 표시할 데이터를 뜻합니다.
- color: 색 정보로써 각 기하 객체가 가질 색을 구분하는데 사용합니다. 보통 명목형 데이터가 사용됩니다.
- group: color의 하위 호환 aes로 데이터는 묶어서 표시하지만 색으로 추가 구분하지는 않습니다.
- alpha: 투명도를 뜻하며 기하 객체의 투명도를 연속형 데이터 표시로 추가 사용하기도 합니다.
- size : 크기를 뜻하며 기하 객체의 크기를 연속형 데이터 표시로 추가 사용하기도 합니다.

---

## color 정보를 aes를 이용해서 mapping 하기

.pull-left[
```{r }
(p_point_color <- p + 
  geom_point(aes(color = continent)))
```
]

.pull-right[
`summary(p_point_color)`로 색 정보가 추가 된것을 확인해 보세요.
]

---
## geom 특징 조절하기
.pull-left[

기하 객체의 각 특징은 굳이 데이터에 매핑 될 필요없이 조절할 수 도 있습니다.

아래 두 `summary`를 확인해서 어떻게 정보가 다른지 확인해 보세요.

```
summary(p + geom_point(alpha = (1/3), size = 3 ))
summary(p + geom_point(aes(alpha = (1/3), size = 3) ))
```
]
.pull-right[
```{r }
p + geom_point(alpha = (1/3), size = 3)
```
]
---
## stat_*() 함수로 layer 추가하기

`stat_*()` 함수는 `geom_*()` 함수의 특별한 형태로써 통계적인 기능들이 추가되어 동작합니다. `geom_*()` 함수 내에서도 통계 함수들을 사용하여 구현할 수도 있습니다.


`stat_*()` 함수의 [공식 설명서](http://ggplot2.tidyverse.org/reference/index.html#section-layer-stats)를 참고하세요.

---

## stat_smooth로 간단히 추세선 추가하기
.pull-left[
```{r }
p_point
```
]

.pull-right[
```{r message=F, warning=FALSE}
p_point + stat_smooth()
```
]

---
## method를 lm(선형회귀)로 변경
.pull-left[
```{r}
p_point + stat_smooth()
```
]
.pull-right[
```{r}
p_point + geom_smooth(lwd = 2, se = FALSE, method = "lm")
```
]
---
## 색정보를 전체에 반형하기

layer를 추가할 때 작성한 mapping 정보는 이후에 더해지는 layer에는 반영되지 않습니다. 그렇기 때문에 공통으로 사용하는 mapping 정보는 최초 `ggplot` 객체 생성시 `aes()` 함수로 반영해야 합니다.

.pull-left[
```{r}
p_point_color + geom_smooth(lwd = 2, se = FALSE)
```
]
.pull-left[
```{r}
p + aes(color = continent) + geom_point() + geom_smooth(lwd = 1, se = FALSE)
```
]
---
## group 과 color

group과 color가 어떻게 다르게 동작하는지 확인하세요.

.pull-left[
```{r}
p + aes(color = continent) + geom_point() + geom_smooth(lwd = 2, se = FALSE)
```
]
.pull-right[
```{r}
p + aes(group = continent)+ geom_point() + geom_smooth(lwd = 2, se = FALSE)
```
]
---

## group으로 차트 나누어 그리기

대륙을 기준으로 차트를 그룹지어 나누어 그릴 수 있습니다. `facet_*()` 함수를 참고하세요.

.pull-left[
```{r}
(lp <- ggplot(gapminder, aes(x = year, y = lifeExp)) + geom_point())
```
]
.pull-right[
```{r}
lp + facet_wrap(~ continent)
```
]

---
## 실습 2
.pull-left[
1. `gapminder`에서 `pop`의 히스토그램(histogram)을 그리세요.
1. `continent`를 x축, `lifeExp`를 y축으로 하는 바이올린차트(violin)를 그리고 평균을 파란색 점으로 추가하세요. 
1. 각 `continent`별로 총 몇 개의 데이터가 있는지 세어 continent_freq를 만들고, bar 차트를 그리세요.
1. Canada, Rwanda, Cambodia, Mexico 4 나라만 사용하여 x축은 year, y축은 lifeExp로 line 차트를 각 년도에 점을 추가하여 그리세요.
]

.pull-right[

```{r echo=F, warning=F, message=F, fig.height=6}
library(gridExtra)
library(dplyr)

p <- ggplot(gapminder)

plot1 <- p + aes(x=pop) + geom_histogram()
plot2 <- p + aes(x=continent, y=lifeExp) + geom_violin() + stat_summary(color="blue")
continent_freq <- gapminder %>% count(continent)
plot3 <- ggplot(continent_freq, aes(x = continent, y = n)) + geom_bar(stat = "identity")

jCountries <- c("Canada", "Rwanda", "Cambodia", "Mexico")
plot4 <- gapminder %>% filter(country %in% jCountries) %>%
  ggplot(aes(x = year, y = lifeExp, color = country)) +
  geom_line() + geom_point()

grid.arrange(plot1, plot2, plot3, plot4, nrow=2, ncol=2)
```
]

---















